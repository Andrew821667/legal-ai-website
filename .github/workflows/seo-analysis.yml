name: Automatic SEO Analysis

on:
  schedule:
    - cron: '0 3 * * 0'
  workflow_dispatch:

jobs:
  seo-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout website
        uses: actions/checkout@v4

      - name: Checkout SEO AI Models
        uses: actions/checkout@v4
        with:
          repository: Andrew821667/seo-ai-models
          path: seo-tools

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd seo-tools
          pip install -e .
          pip install playwright beautifulsoup4 lxml tiktoken openai
          python -m playwright install chromium

      - name: Run SEO analysis
        run: |
          mkdir -p seo-reports
          pip install requests
          python .github/workflows/analyze_seo.py

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: seo-analysis-report
          path: seo-reports/
          retention-days: 90

      - name: Display Summary
        run: |
          echo "üìä SEO Analysis Summary:"
          cat seo-reports/SUMMARY.md

      - name: Create Summary Issue
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('seo-reports/SUMMARY.md', 'utf8');

            // –ß–∏—Ç–∞–µ–º JSON –æ—Ç—á–µ—Ç –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            const reportFiles = fs.readdirSync('seo-reports').filter(f => f.endsWith('.json'));
            const reportData = JSON.parse(fs.readFileSync(`seo-reports/${reportFiles[0]}`, 'utf8'));

            // –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π issue —Å summary
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üìä SEO Report ${new Date().toISOString().split('T')[0]} - Score: ${reportData.overall_score}/100`,
              body: `${summary}\n\n---\n\n**Predicted Position:** ${reportData.predicted_position}\n**Readability:** ${reportData.seo_analysis.content_metrics.readability * 100}/100\n**E-E-A-T Score:** ${(reportData.seo_analysis.content_metrics.overall_eeat_score * 100).toFixed(0)}/100\n\n[Download full report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['seo', 'report', 'automated']
            });

      - name: Create Priority Issues
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportFiles = fs.readdirSync('seo-reports').filter(f => f.endsWith('.json'));
            const reportData = JSON.parse(fs.readFileSync(`seo-reports/${reportFiles[0]}`, 'utf8'));

            // –ë–µ—Ä–µ–º —Ç–æ–ø-5 –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –∑–∞–¥–∞—á
            const topTasks = reportData.seo_analysis.priorities.slice(0, 5);

            for (const task of topTasks) {
              let label = 'seo-medium';
              if (task.priority_score >= 0.7) {
                label = 'seo-critical';
              } else if (task.priority_score >= 0.5) {
                label = 'seo-high';
              }

              const body = `**Priority Score:** ${task.priority_score.toFixed(2)}\n**Impact:** ${task.impact.toFixed(2)}\n**Effort:** ${task.effort.toFixed(2)}\n\n**Feature:** ${task.feature}\n\n---\n\n*–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ –∏–∑ SEO –∞–Ω–∞–ª–∏–∑–∞ ${new Date().toISOString().split('T')[0]}*`;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[SEO] ${task.task}`,
                body: body,
                labels: ['seo', 'improvement', label, 'automated']
              });
            }
