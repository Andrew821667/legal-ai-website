name: Automatic SEO Analysis

on:
  schedule:
    - cron: '0 3 * * 0'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'components/**'

jobs:
  seo-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout website
        uses: actions/checkout@v4

      - name: Checkout SEO AI Models
        uses: actions/checkout@v4
        with:
          repository: Andrew821667/seo-ai-models
          path: seo-tools

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd seo-tools
          pip install -e .
          playwright install chromium

      - name: Run SEO analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          mkdir -p seo-reports
          cd seo-tools
          python -c "
import json
import sys
from datetime import datetime

sys.path.insert(0, '.')

SITE_URL = 'https://legal-ai-website-iota.vercel.app'

try:
    from seo_ai_models.models.seo_advisor.advisor import SEOAdvisor
    from seo_ai_models.parsers.parsing_pipeline import ParsingPipeline

    print('Modules imported successfully')

    pipeline = ParsingPipeline()
    advisor = SEOAdvisor()

    print(f'Analyzing: {SITE_URL}')

    page_data = pipeline.analyze_url(SITE_URL)

    if page_data and 'content' in page_data:
        seo_report = advisor.analyze_content(page_data['content'])
    else:
        seo_report = {}

    results = {
        'timestamp': datetime.now().isoformat(),
        'site_url': SITE_URL,
        'page_data': page_data,
        'seo_analysis': seo_report,
        'overall_score': seo_report.get('score', 0)
    }

    with open('../seo-reports/report.json', 'w', encoding='utf-8') as f:
        json.dump(results, f, ensure_ascii=False, indent=2)

    with open('../seo-reports/SUMMARY.md', 'w') as f:
        f.write(f'# SEO Analysis Report\\n\\n')
        f.write(f'Date: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}\\n\\n')
        f.write(f'Site: {SITE_URL}\\n\\n')
        f.write(f'Score: {results[\"overall_score\"]}/100\\n')

    print('Analysis complete!')

except Exception as e:
    print(f'Error: {e}')
    import traceback
    traceback.print_exc()
    sys.exit(1)
"

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: seo-analysis-report
          path: seo-reports/
          retention-days: 90

      - name: Display Summary
        run: cat seo-reports/SUMMARY.md
